# 决策 007: 和弦转位功能设计

## 状态
- 提议日期: 2024-03-27
- 状态: 提议中
- 实施者: TBD

## 背景与问题
在音乐理论中，和弦转位是一个重要的概念，它通过改变和弦中音符的排列顺序来创造不同的声音效果。目前系统支持基本和弦的生成，但尚未支持和弦的转位功能。为了提供更丰富的和声效果，我们需要实现和弦转位的支持。

## 决策
我们将实现以下和弦转位相关功能：

### 1. 核心功能
- 支持三和弦的所有转位形式：
  - 原位（Root position）
  - 第一转位（First inversion）
  - 第二转位（Second inversion）
- 支持七和弦的所有转位形式：
  - 原位
  - 第一转位
  - 第二转位
  - 第三转位
- 快捷键操作：
  - 单击 Q：循环切换转位状态（原位 -> 第一转位 -> 第二转位 -> [第三转位] -> 原位）
  - 双击 Q：直接回到原位
  - 注：三和弦的第三转位等同于原位

### 2. 数据结构设计
```python
class ChordInversion:
    def __init__(self, chord_notes: List[Note], inversion: int = 0):
        self.original_notes = chord_notes  # 原始和弦音符列表
        self.inversion = inversion        # 转位数（0=原位）
        self.inverted_notes = []         # 转位后的音符列表
        self.chord_type = None           # 和弦类型（三和弦/七和弦）
        self.max_inversion = None        # 最大转位数（三和弦=2，七和弦=3）
```

### 3. API 设计
```python
def get_chord_inversion(chord: Chord, inversion: int) -> List[Note]:
    """
    获取指定和弦的转位形式
    
    Args:
        chord: 原始和弦对象
        inversion: 转位数（0=原位，1=第一转位，以此类推）
    
    Returns:
        转位后的音符列表
    """

def cycle_inversion(chord: Chord) -> int:
    """
    循环切换和弦转位状态
    
    Args:
        chord: 当前和弦对象
    
    Returns:
        新的转位数
    """

def reset_to_root_position(chord: Chord) -> None:
    """
    将和弦重置为原位
    """
```

### 4. 实现方法
1. 转位算法：
   - 获取原始和弦的音符列表
   - 根据转位数，将指定数量的低音音符移动到高八度
   - 保持音符的相对顺序不变

2. 边界处理：
   - 验证转位数的有效性（不超过和弦音符数-1）
   - 处理无效输入的异常情况
   - 确保音符在合理的音域范围内

3. 快捷键处理：
   - 监听键盘 Q 键事件
   - 区分单击和双击事件（设置合适的双击时间阈值）
   - 根据和弦类型决定最大转位数

### 5. 用户界面
- 在钢琴键盘上方添加转位状态显示区域：
  - 显示当前和弦名称和转位状态
  - 示例：C（原位）、C/E（第一转位）、C/G（第二转位）
  - 使用清晰的视觉样式区分不同转位状态
- 在和弦显示时提供转位选项
- 使用标准的和弦转位标记法
- 提供直观的转位选择界面
- 添加快捷键提示（Q：循环转位，双击Q：重置）

## 影响
1. 技术影响
   - 需要扩展现有的和弦类
   - 需要修改和弦生成和显示逻辑
   - 可能需要更新音符排序和定位算法
   - 需要实现键盘事件处理机制

2. 用户体验影响
   - 提供更丰富的和声选择
   - 增加学习曲线
   - 需要补充相关文档和教程
   - 快捷键操作提高使用效率

## 风险
1. 实现复杂度增加
2. 可能影响现有和弦生成的性能
3. 用户可能需要额外学习成本
4. 快捷键可能与其他功能冲突

## 替代方案
1. 仅支持三和弦转位
2. 使用预计算的转位表
3. 简化转位标记方式
4. 使用其他快捷键组合

## 行动项目
1. [ ] 实现 ChordInversion 类
2. [ ] 编写单元测试
3. [ ] 实现快捷键处理逻辑
4. [ ] 设计和实现转位状态显示区域
5. [ ] 更新用户界面
6. [ ] 补充文档和示例
7. [ ] 进行性能测试
8. [ ] 进行用户测试验证快捷键操作的便利性

## 相关文档
- 音乐理论参考
- 现有和弦实现文档
- 用户界面规范
- 键盘事件处理文档 